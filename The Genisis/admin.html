<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Mistress Obsidian Tribute Control</title>
  <style>
    body { background: #0d0d0d; color: #e6e6e6; font-family: 'Georgia', serif; margin:0; }
    .admin-box { background: #181818; max-width: 950px; margin: 48px auto; border-radius: 10px; box-shadow: 0 0 18px #99000055; padding: 40px 24px; }
    h2 { color: #ff1a1a; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 34px; }
    th, td { padding: 13px 10px; border-bottom: 1px solid #333; text-align: center; }
    th { background: #990000; color: #fff; }
    tr:nth-child(even) { background: #171717; }
    tr:nth-child(odd) { background: #1e1e1e; }
    .status { font-weight: bold; }
    .accepted { color: #39ff14; }
    .pending { color: #ffd700; }
    .declined { color: #ff1a1a; }
    button { padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 0 2px; }
    .accept { background: #228b22; color: #fff; }
    .accept:hover { background: #39ff14; color: #181818; }
    .decline { background: #900; color: #fff; }
    .decline:hover { background: #ff3333; color: #181818; }
    .undo { background: #444; color: #fff; }
    .undo:hover { background: #ffbb00; color: #181818; }
    .edit { background: #0077cc; color: #fff; }
    .edit:hover { background: #33bbff; color: #181818; }
    .delete { background: #990000; color: #fff; }
    .delete:hover { background: #ff1a1a; color: #fff; }
    .notify { background: #9e6b16; color: #fff; }
    .notify:hover { background: #ffd700; color: #181818; }
    .logout { margin-top: 25px; background: #333; color: #fff; }
    .logout:hover { background: #990000; }
    .search-bar { width: 99%; margin: 18px 0 5px 0; padding: 8px 12px; border-radius: 6px; border: 1px solid #333; background: #232323; color: #fff; font-size: 1.05em;}
    #editModal, #addModal { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background:rgba(0,0,0,0.82); align-items: center; justify-content: center; z-index: 1000;}
    .modal-content { background: #212121; padding: 32px 25px; border-radius: 10px; max-width: 320px; margin:auto; color: #fff; }
    .modal-content label { display: block; margin-top: 15px; }
    .modal-content input, .modal-content select { width: 100%; padding: 8px 10px; border-radius: 4px; background: #333; border: none; color: #fff; margin-top: 4px;}
    .modal-content .modal-actions { margin-top: 22px; text-align: center; }
    .modal-content button { margin: 0 6px 0 0; }
    .add-btn { margin-top: 15px; margin-bottom: 8px; background: #990000; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight:bold;}
    .add-btn:hover { background: #ff1a1a; }
    @media (max-width: 1100px) {
      .admin-box { padding: 10px 2vw; }
      table { font-size: 0.97em; }
      th, td { padding: 7px 4px; }
    }
    @media (max-width: 600px) {
      .admin-box { padding: 5px 0; }
      table { font-size: 0.87em; }
    }
  </style>
</head>
<body>
  <div class="admin-box">
    <h2>Mistress Tribute Control Panel</h2>
    <button class="add-btn" onclick="openAdd()">+ Add New User</button>
    <input class="search-bar" id="user-search" type="text" placeholder="Search slave name or email..." oninput="loadUsers()">
    <table id="user-table">
      <thead>
        <tr>
          <th>Slave Name</th>
          +<th>Role</th>
          <th>Tribute Paid</th>
          <th>Tribute Approval</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="user-tbody">
        <!-- Users will load here -->
      </tbody>
    </table>
    <button class="logout" onclick="logout()">Log out</button>
  </div>

  <!-- Edit User Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h3>Edit User</h3>
      <form id="editForm">
        <input type="hidden" id="editIndex">
        <label>Slave Name <input type="text" id="editName" required maxlength="20"></label>
        <label>Email <input type="email" id="editEmail" required></label>
        <label>Role
          <select id="editRole" required>
            <option value="slave">Slave</option>
            <option value="pet">Pet</option>
            <option value="keyholder">Keyholder</option>
            <option value="admin">Admin</option>
          </select>
        </label>
        <label>Reset Password <input type="text" id="editPass" placeholder="(leave blank to keep)"></label>
        <div class="modal-actions">
          <button type="submit" class="accept">Save</button>
          <button type="button" onclick="closeEdit()" class="decline">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addModal">
    <div class="modal-content">
      <h3>Add New User</h3>
      <form id="addForm">
        <label>Slave Name <input type="text" id="addName" required maxlength="20"></label>
        <label>Email <input type="email" id="addEmail" required></label>
        <label>Role
          <select id="addRole" required>
            <option value="slave">Slave</option>
            <option value="pet">Pet</option>
            <option value="keyholder">Keyholder</option>
            <option value="admin">Admin</option>
          </select>
        </label>
        <label>Password <input type="text" id="addPass" required minlength="4"></label>
        <div class="modal-actions">
          <button type="submit" class="accept">Add User</button>
          <button type="button" onclick="closeAdd()" class="decline">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Only admins can access this panel
    if (localStorage.getItem('role') !== 'admin') {
      window.location.href = 'login.html';
    }

    // Helper: Display tribute paid status
    function displayPaidStatus(paid) {
      if (paid === true) return '<span class="status accepted">Yes</span>';
      return '<span class="status declined">No</span>';
    }

    // Helper: Display tribute approval status
    function displayApprovalStatus(status) {
      if (status === true) return '<span class="status accepted">Accepted</span>';
      if (status === false) return '<span class="status declined">Declined</span>';
      return '<span class="status pending">Pending</span>';
    }

    // Load users and tribute statuses to table
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const tributeStatus = JSON.parse(localStorage.getItem('tributeStatus') || '{}');
      const confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      const search = document.getElementById('user-search').value.trim().toLowerCase();
      let html = '';

      users.forEach((user, idx) => {
        if (
          search &&
          !user.username.toLowerCase().includes(search) &&
          !user.email.toLowerCase().includes(search)
        ) return;

        const paid = tributeStatus[user.username] === true;
        let approval = null;
        if (paid) {
          approval = confirmedTribute.hasOwnProperty(user.username) ? confirmedTribute[user.username] : null;
        }

        html += `
          <tr>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>${displayPaidStatus(paid)}</td>
            <td>${displayApprovalStatus(approval)}</td>
            <td>
              <button class="accept" onclick="handleTributeAction('accept', '${user.username}')">Accept</button>
              <button class="decline" onclick="handleTributeAction('decline', '${user.username}')">Decline</button>
              <button class="undo" onclick="handleTributeAction('undo', '${user.username}')">Undo</button>
              <button class="edit" onclick="editUser(${idx})">Edit</button>
              <button class="delete" onclick="deleteUser(${idx})">Delete</button>
              <button class="notify" onclick="notifyUser('${user.email}', '${user.username}')">Notify</button>
            </td>
          </tr>
        `;
      });

      document.getElementById('user-tbody').innerHTML = html;
    }

    // Tribute action handler
    function handleTributeAction(action, username) {
      let msg = '';
      if (action === 'accept') msg = `Accept tribute from ${username}?`;
      else if (action === 'decline') msg = `Decline tribute from ${username}?`;
      else if (action === 'undo') msg = `Undo tribute decision for ${username}?`;
      else if (action === 'notify') msg = `Send notification email to ${username}?`;

      if (!confirm(msg)) return;

      if (action === 'accept') confirmTribute(username, true);
      else if (action === 'decline') confirmTribute(username, false);
      else if (action === 'undo') undoTribute(username);
      else if (action === 'notify') notifyUserByEmail(username);
    }

    // Confirm tribute acceptance or decline
    function confirmTribute(username, accepted) {
      let confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      confirmedTribute[username] = accepted;
      localStorage.setItem('confirmedTribute', JSON.stringify(confirmedTribute));
      loadUsers();
      sendStatusEmail(username, accepted);
    }

    // Undo tribute decision
    function undoTribute(username) {
      let confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      if (confirmedTribute.hasOwnProperty(username)) {
        delete confirmedTribute[username];
        localStorage.setItem('confirmedTribute', JSON.stringify(confirmedTribute));
        loadUsers();
      }
    }

    // Delete user and related data
    function deleteUser(idx) {
      if (!confirm("Are you sure you want to delete this user? This action cannot be undone.")) return;

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const uname = users[idx].username;
      users.splice(idx, 1);
      localStorage.setItem('users', JSON.stringify(users));

      let tributeStatus = JSON.parse(localStorage.getItem('tributeStatus') || '{}');
      let confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      delete tributeStatus[uname];
      delete confirmedTribute[uname];
      localStorage.setItem('tributeStatus', JSON.stringify(tributeStatus));
      localStorage.setItem('confirmedTribute', JSON.stringify(confirmedTribute));

      loadUsers();
    }

    // Edit user modal open
    function editUser(idx) {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users[idx];
      document.getElementById('editIndex').value = idx;
      document.getElementById('editName').value = user.username;
      document.getElementById('editEmail').value = user.email;
      document.getElementById('editRole').value = user.role;
      document.getElementById('editPass').value = "";
      document.getElementById('editModal').style.display = 'flex';
    }

    // Close edit modal
    function closeEdit() {
      document.getElementById('editModal').style.display = 'none';
    }

    // Save edit form
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if (!confirm("Save changes to this user?")) return;

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const idx = document.getElementById('editIndex').value;
      const newName = document.getElementById('editName').value.trim();
      const newEmail = document.getElementById('editEmail').value.trim();
      const newRole = document.getElementById('editRole').value;
      const newPass = document.getElementById('editPass').value;

      if (!newName || !newEmail || !newRole) return;

      // Check for username conflict (except for same user)
      if (users.some((u, i) => u.username === newName && i != idx)) {
        alert("Username already exists.");
        return;
      }

      users[idx].username = newName;
      users[idx].email = newEmail;
      users[idx].role = newRole;
      if (newPass) users[idx].password = newPass;

      localStorage.setItem('users', JSON.stringify(users));
      closeEdit();
      loadUsers();
    });

    // Open add user modal
    function openAdd() {
      document.getElementById('addName').value = '';
      document.getElementById('addEmail').value = '';
      document.getElementById('addRole').value = 'slave';
      document.getElementById('addPass').value = '';
      document.getElementById('addModal').style.display = 'flex';
    }

    // Close add modal
    function closeAdd() {
      document.getElementById('addModal').style.display = 'none';
    }

    // Add user form submission
    document.getElementById('addForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if (!confirm("Confirm and create this user?")) return;

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const newName = document.getElementById('addName').value.trim();
      const newEmail = document.getElementById('addEmail').value.trim();
      const newRole = document.getElementById('addRole').value;
      const newPass = document.getElementById('addPass').value;

      if (!newName || !newEmail || !newRole || !newPass) return;

      if (users.some(u => u.username === newName)) {
        alert("Username already exists.");
        return;
      }

      users.push({ username: newName, email: newEmail, role: newRole, password: newPass });
      localStorage.setItem('users', JSON.stringify(users));
      closeAdd();
      loadUsers();
    });

    // Notify user by email (mailto)
    function notifyUser(email, username) {
      const body = encodeURIComponent(`Dear ${username},\n\n[Your message here]\n\n- Mistress Obsidian`);
      window.open(`mailto:${email}?subject=Mistress Obsidian Notification&body=${body}`);
    }

    // Send tribute status email
    function sendStatusEmail(username, accepted) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.username === username);
      if (!user) return;

      let msg = accepted
        ? "Your tribute has been accepted by Mistress Obsidian. You may now access the Private Chamber."
        : "Your tribute has been declined by Mistress Obsidian. Please contact Mistress for more information.";

      const body = encodeURIComponent(`Dear ${username},\n\n${msg}\n\n- Mistress Obsidian`);
      window.open(`mailto:${user.email}?subject=Tribute Status Update&body=${body}`);
    }

    // Logout
    function logout() {
      localStorage.removeItem('authenticated');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = 'login.html';
    }

    // Load users on page load
    loadUsers();
  </script>
</body>
</html>