<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Mistress Obsidian Tribute Control</title>
  <style>
    /* ... (keep your CSS unchanged) ... */
  </style>
</head>
<body>
  <div class="admin-box">
    <h2>Mistress Tribute Control Panel</h2>
    <button class="add-btn" onclick="openAdd()">+ Add New User</button>
    <input class="search-bar" id="user-search" type="text" placeholder="Search slave name or email..." oninput="loadUsers()">
    <table id="user-table">
      <thead>
        <tr>
          <th>Slave Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Tribute Paid</th>
          <th>Tribute Approval</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="user-tbody">
        <!-- Users will load here -->
      </tbody>
    </table>
    <button class="logout" onclick="logout()">Log out</button>
  </div>

  <!-- Edit/Add User Modals (keep unchanged) ... -->

  <script>
    // Only admins can access this panel
    if (localStorage.getItem('role') !== 'admin') {
      window.location.href = 'login.html';
    }

    // Helper: Display tribute paid status
    function displayPaidStatus(paid) {
      if (paid === true) return '<span class="status accepted">Yes</span>';
      return '<span class="status declined">No</span>';
    }
    function displayApprovalStatus(status) {
      if (status === true) return '<span class="status accepted">Accepted</span>';
      if (status === false) return '<span class="status declined">Declined</span>';
      return '<span class="status pending">Pending</span>';
    }

    // Load users and tribute statuses to table
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const tributeStatus = JSON.parse(localStorage.getItem('tributeStatus') || '{}');
      const confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      const search = document.getElementById('user-search').value.trim().toLowerCase();
      let html = '';

      users.forEach((user, idx) => {
        if (
          search &&
          !user.username.toLowerCase().includes(search) &&
          !user.email.toLowerCase().includes(search)
        ) return;

        const paid = tributeStatus[user.username] === true;
        let approval = null;
        if (paid) {
          approval = confirmedTribute.hasOwnProperty(user.username) ? confirmedTribute[user.username] : null;
        }

        html += `
          <tr>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>${displayPaidStatus(paid)}</td>
            <td>${displayApprovalStatus(approval)}</td>
            <td>
              <button class="accept" onclick="handleTributeAction('accept', '${user.username}')">Accept</button>
              <button class="decline" onclick="handleTributeAction('decline', '${user.username}')">Decline</button>
              <button class="undo" onclick="handleTributeAction('undo', '${user.username}')">Undo</button>
              <button class="edit" onclick="editUser(${idx})">Edit</button>
              <button class="delete" onclick="deleteUser(${idx})">Delete</button>
              <button class="notify" onclick="notifyUser('${user.email}', '${user.username}')">Notify</button>
            </td>
          </tr>
        `;
      });

      document.getElementById('user-tbody').innerHTML = html;
    }

    // Tribute action handler
    function handleTributeAction(action, username) {
      let msg = '';
      if (action === 'accept') msg = `Accept tribute from ${username}?`;
      else if (action === 'decline') msg = `Decline tribute from ${username}?`;
      else if (action === 'undo') msg = `Undo tribute decision for ${username}?`;

      if (!confirm(msg)) return;

      if (action === 'accept') confirmTribute(username, true);
      else if (action === 'decline') confirmTribute(username, false);
      else if (action === 'undo') undoTribute(username);
    }

    // Confirm tribute acceptance or decline and sync to SheetDB
    function confirmTribute(username, accepted) {
      let tributeStatus = JSON.parse(localStorage.getItem('tributeStatus') || '{}');
      let confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');

      if (accepted) {
        tributeStatus[username] = true; // Paid
        confirmedTribute[username] = true; // Approved
      } else {
        tributeStatus[username] = false; // Not paid
        confirmedTribute[username] = false; // Declined
      }

      localStorage.setItem('tributeStatus', JSON.stringify(tributeStatus));
      localStorage.setItem('confirmedTribute', JSON.stringify(confirmedTribute));
      loadUsers();

      // Sync to SheetDB
      syncUserToSheetDB(username, tributeStatus[username], confirmedTribute[username]);

      sendStatusEmail(username, accepted);
    }

    // Undo tribute decision and sync to SheetDB
    function undoTribute(username) {
      let tributeStatus = JSON.parse(localStorage.getItem('tributeStatus') || '{}');
      let confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      tributeStatus[username] = false;
      delete confirmedTribute[username];
      localStorage.setItem('tributeStatus', JSON.stringify(tributeStatus));
      localStorage.setItem('confirmedTribute', JSON.stringify(confirmedTribute));
      loadUsers();
      // Sync to SheetDB (set back to No/Pending)
      syncUserToSheetDB(username, false, "");
    }

    // Delete user and related data
    function deleteUser(idx) {
      if (!confirm("Are you sure you want to delete this user? This action cannot be undone.")) return;

      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const uname = users[idx].username;
      users.splice(idx, 1);
      localStorage.setItem('users', JSON.stringify(users));

      let tributeStatus = JSON.parse(localStorage.getItem('tributeStatus') || '{}');
      let confirmedTribute = JSON.parse(localStorage.getItem('confirmedTribute') || '{}');
      delete tributeStatus[uname];
      delete confirmedTribute[uname];
      localStorage.setItem('tributeStatus', JSON.stringify(tributeStatus));
      localStorage.setItem('confirmedTribute', JSON.stringify(confirmedTribute));

      loadUsers();
      // Optionally, sync deletion to SheetDB (requires SheetDB delete endpoint)
    }

    // --- SHEETDB INTEGRATION ---
    function syncUserToSheetDB(username, tributePaid, tributeApproved) {
      // Find user email & other info
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.username === username);
      if (!user) return;

      // Prepare API body (adjust column names to match your Google Sheet)
      const data = {
        "username": username,
        "email": user.email || "",
        "role": user.role || "",
        "tributePaid": tributePaid ? "Yes" : "No",
        "tributeApproved": tributeApproved === true ? "Yes" : tributeApproved === false ? "No" : ""
      };

      // PATCH will update the first row that matches the username
      fetch('https://sheetdb.io/api/v1/a51mmkqkea3wh/username/' + encodeURIComponent(username), {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data })
      })
      .then(r => r.json())
      .then(res => {
        // Optional: log or notify success
        // alert('Synced with Google Sheet!');
      })
      .catch(() => {
        alert('Error syncing with Google Sheet. Changes will remain local only.');
      });
    }

    // Notify user by email (mailto)
    function notifyUser(email, username) {
      const body = encodeURIComponent(`Dear ${username},\n\n[Your message here]\n\n- Mistress Obsidian`);
      window.open(`mailto:${email}?subject=Mistress Obsidian Notification&body=${body}`);
    }

    // Send tribute status email
    function sendStatusEmail(username, accepted) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.username === username);
      if (!user) return;

      let msg = accepted
        ? "Your tribute has been accepted by Mistress Obsidian. You may now access the Private Chamber."
        : "Your tribute has been declined by Mistress Obsidian. Please contact Mistress for more information.";

      const body = encodeURIComponent(`Dear ${username},\n\n${msg}\n\n- Mistress Obsidian`);
      window.open(`mailto:${user.email}?subject=Tribute Status Update&body=${body}`);
    }

    // Logout
    function logout() {
      localStorage.removeItem('authenticated');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = 'login.html';
    }

    // Load users on page load
    loadUsers();
  </script>
</body>
</html>