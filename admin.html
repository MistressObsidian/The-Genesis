<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Mistress Obsidian Tribute Control</title>
  <style>
    body { background: #0d0d0d; color: #e6e6e6; font-family: 'Georgia', serif; margin:0; }
    .admin-box { background: #181818; max-width: 950px; margin: 48px auto; border-radius: 10px; box-shadow: 0 0 18px #99000055; padding: 40px 24px; }
    h2 { color: #ff1a1a; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 34px; }
    th, td { padding: 13px 10px; border-bottom: 1px solid #333; text-align: center; }
    th { background: #990000; color: #fff; }
    tr:nth-child(even) { background: #171717; }
    tr:nth-child(odd) { background: #1e1e1e; }
    .status { font-weight: bold; }
    .accepted { color: #39ff14; }
    .pending { color: #ffd700; }
    .declined { color: #ff1a1a; }
    button { padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 0 2px; }
    .accept { background: #228b22; color: #fff; }
    .accept:hover { background: #39ff14; color: #181818; }
    .decline { background: #900; color: #fff; }
    .decline:hover { background: #ff3333; color: #181818; }
    .undo { background: #444; color: #fff; }
    .undo:hover { background: #ffbb00; color: #181818; }
    .edit { background: #0077cc; color: #fff; }
    .edit:hover { background: #33bbff; color: #181818; }
    .delete { background: #990000; color: #fff; }
    .delete:hover { background: #ff1a1a; color: #fff; }
    .notify { background: #9e6b16; color: #fff; }
    .notify:hover { background: #ffd700; color: #181818; }
    .logout { margin-top: 25px; background: #333; color: #fff; }
    .logout:hover { background: #990000; }
    .search-bar { width: 99%; margin: 18px 0 5px 0; padding: 8px 12px; border-radius: 6px; border: 1px solid #333; background: #232323; color: #fff; font-size: 1.05em;}
    #editModal, #addModal { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background:rgba(0,0,0,0.82); align-items: center; justify-content: center; z-index: 1000;}
    .modal-content { background: #212121; padding: 32px 25px; border-radius: 10px; max-width: 320px; margin:auto; color: #fff; }
    .modal-content label { display: block; margin-top: 15px; }
    .modal-content input, .modal-content select { width: 100%; padding: 8px 10px; border-radius: 4px; background: #333; border: none; color: #fff; margin-top: 4px;}
    .modal-content .modal-actions { margin-top: 22px; text-align: center; }
    .modal-content button { margin: 0 6px 0 0; }
    .add-btn { margin-top: 15px; margin-bottom: 8px; background: #990000; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight:bold;}
    .add-btn:hover { background: #ff1a1a; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .spinner { display: inline-block; width: 18px; height: 18px; vertical-align: middle;}
    .spinner-inner { display: block; width: 18px; height: 18px; border-radius: 50%; border: 3px solid #fff; border-color: #fff #fff #990000 #fff; animation: spin 0.8s linear infinite; }
    @media (max-width: 1100px) {
      .admin-box { padding: 10px 2vw; }
      table { font-size: 0.97em; }
      th, td { padding: 7px 4px; }
    }
    @media (max-width: 600px) {
      .admin-box { padding: 5px 0; }
      table { font-size: 0.87em; }
    }
  </style>
</head>
<body>
  <div class="admin-box">
    <h2>Mistress Tribute Control Panel</h2>
    <button class="add-btn" onclick="openAdd()">+ Add New User</button>
    <input class="search-bar" id="user-search" type="text" placeholder="Search slave name or email..." oninput="loadUsers()">
    <table id="user-table">
      <thead>
        <tr>
          <th>Slave Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Tribute Paid</th>
          <th>Tribute Approval</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="user-tbody">
        <!-- Users will load here -->
      </tbody>
    </table>
    <button class="logout" onclick="logout()">Log out</button>
  </div>

  <!-- Edit User Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h3>Edit User</h3>
      <form id="editForm">
        <input type="hidden" id="editIndex">
        <label>Slave Name <input type="text" id="editName" required maxlength="20"></label>
        <label>Email <input type="email" id="editEmail" required></label>
        <label>Role
          <select id="editRole" required>
            <option value="slave">Slave</option>
            <option value="pet">Pet</option>
            <option value="keyholder">Keyholder</option>
            <option value="admin">Admin</option>
          </select>
        </label>
        <label>Reset Password <input type="text" id="editPass" placeholder="(leave blank to keep)"></label>
        <div class="modal-actions">
          <button type="submit" class="accept">Save</button>
          <button type="button" onclick="closeEdit()" class="decline">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addModal">
    <div class="modal-content">
      <h3>Add New User</h3>
      <form id="addForm">
        <label>Slave Name <input type="text" id="addName" required maxlength="20"></label>
        <label>Email <input type="email" id="addEmail" required></label>
        <label>Role
          <select id="addRole" required>
            <option value="slave">Slave</option>
            <option value="pet">Pet</option>
            <option value="keyholder">Keyholder</option>
            <option value="admin">Admin</option>
          </select>
        </label>
        <label>Password <input type="text" id="addPass" required minlength="4"></label>
        <label>Tribute Paid
          <select id="addPaid" required>
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </label>
        <label>Tribute Approval
          <select id="addApproval" required>
            <option value="">Pending</option>
            <option value="true">Accepted</option>
            <option value="false">Declined</option>
          </select>
        </label>
        <div class="modal-actions">
          <button type="submit" class="accept">Add User</button>
          <button type="button" onclick="closeAdd()" class="decline">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ==== SheetDB endpoint ====
    const SHEETDB_API = 'https://sheetdb.io/api/v1/a51mmkqkea3wh';

    if (localStorage.getItem('role') !== 'admin') {
      window.location.href = 'login.html';
    }

    function displayPaidStatus(paid) {
      if (paid === "true" || paid === true) return '<span class="status accepted">Yes</span>';
      return '<span class="status declined">No</span>';
    }
    function displayApprovalStatus(status) {
      if (status === "true" || status === true) return '<span class="status accepted">Accepted</span>';
      if (status === "false" || status === false) return '<span class="status declined">Declined</span>';
      return '<span class="status pending">Pending</span>';
    }

    async function loadUsers() {
      const search = document.getElementById('user-search').value.trim().toLowerCase();
      let res = await fetch(SHEETDB_API);
      let users = await res.json();
      let html = '';

      users.forEach((user, idx) => {
        if (
          search &&
          !user.username?.toLowerCase().includes(search) &&
          !user.email?.toLowerCase().includes(search)
        ) return;
        html += `
          <tr>
            <td>${user.username || ''}</td>
            <td>${user.email || ''}</td>
            <td>${user.role || ''}</td>
            <td>${displayPaidStatus(user.tributePaid)}</td>
            <td>${displayApprovalStatus(user.tributeApproved)}</td>
            <td>
              <button class="accept" onclick="handleTributeAction('accept', '${user.id || user.row || idx}', this)">Accept</button>
              <button class="decline" onclick="handleTributeAction('decline', '${user.id || user.row || idx}', this)">Decline</button>
              <button class="undo" onclick="handleTributeAction('undo', '${user.id || user.row || idx}', this)">Undo</button>
              <button class="edit" onclick="editUser(${idx})">Edit</button>
              <button class="delete" onclick="deleteUser('${user.id || user.row || idx}')">Delete</button>
              <button class="notify" onclick="notifyUser('${user.email}', '${user.username}')">Notify</button>
            </td>
          </tr>
        `;
      });

      document.getElementById('user-tbody').innerHTML = html;
      window._latestUsers = users; // for edit modal
    }

    // Approve/Decline with loading feedback
    function handleTributeAction(action, userId, btn) {
      let msg = '';
      if (action === 'accept') msg = `Accept tribute from this user?`;
      else if (action === 'decline') msg = `Decline tribute from this user?`;
      else if (action === 'undo') msg = `Undo tribute decision for this user?`;

      if (!confirm(msg)) return;

      const row = btn.closest('tr');
      const statusCell = row.cells[4];
      statusCell.innerHTML = `<span style="color:#ffd700;font-weight:bold;">Loading...</span>
        <span class="spinner"><span class="spinner-inner"></span></span>`;

      setTimeout(async () => {
        if (action === 'accept') {
          statusCell.innerHTML = `<span style="color:#39ff14;font-weight:bold;">Approved</span>`;
          await updateUserField(userId, 'tributeApproved', true);
        } else if (action === 'decline') {
          statusCell.innerHTML = `<span style="color:#ff1a1a;font-weight:bold;">Declined</span>`;
          await updateUserField(userId, 'tributeApproved', false);
        } else if (action === 'undo') {
          statusCell.innerHTML = `<span style="color:#ffd700;font-weight:bold;">Pending</span>`;
          await updateUserField(userId, 'tributeApproved', "");
        }
        loadUsers();
      }, 2000);
    }

    async function updateUserField(id, field, value) {
      await fetch(`${SHEETDB_API}/id/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [field]: value })
      });
    }

    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user? This action cannot be undone.")) return;
      await fetch(`${SHEETDB_API}/id/${id}`, { method: 'DELETE' });
      loadUsers();
    }

    // Edit user modal open
    function editUser(idx) {
      const user = window._latestUsers[idx];
      document.getElementById('editIndex').value = user.id || user.row || idx;
      document.getElementById('editName').value = user.username || '';
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editRole').value = user.role || '';
      document.getElementById('editPass').value = "";
      document.getElementById('editModal').style.display = 'flex';
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!confirm("Save changes to this user?")) return;
      const id = document.getElementById('editIndex').value;
      const username = document.getElementById('editName').value.trim();
      const email = document.getElementById('editEmail').value.trim();
      const role = document.getElementById('editRole').value;
      const password = document.getElementById('editPass').value;
      let updateObj = { username, email, role };
      if (password) updateObj.password = password;
      await fetch(`${SHEETDB_API}/id/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateObj)
      });
      closeEdit();
      loadUsers();
    });

    function openAdd() {
      document.getElementById('addName').value = '';
      document.getElementById('addEmail').value = '';
      document.getElementById('addRole').value = 'slave';
      document.getElementById('addPass').value = '';
      document.getElementById('addPaid').value = 'false';
      document.getElementById('addApproval').value = '';
      document.getElementById('addModal').style.display = 'flex';
    }
    function closeAdd() { document.getElementById('addModal').style.display = 'none'; }

    document.getElementById('addForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!confirm("Confirm and create this user?")) return;
      const username = document.getElementById('addName').value.trim();
      const email = document.getElementById('addEmail').value.trim();
      const role = document.getElementById('addRole').value;
      const password = document.getElementById('addPass').value;
      const tributePaid = document.getElementById('addPaid').value;
      const tributeApproved = document.getElementById('addApproval').value;
      await fetch(SHEETDB_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([{ username, email, role, password, tributePaid, tributeApproved }])
      });
      closeAdd();
      loadUsers();
    });

    // Notify user by email (mailto)
    function notifyUser(email, username) {
      const body = encodeURIComponent(`Dear ${username},\n\n[Your message here]\n\n- Mistress Obsidian`);
      window.open(`mailto:${email}?subject=Mistress Obsidian Notification&body=${body}`);
    }

    // Logout
    function logout() {
      localStorage.removeItem('authenticated');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = 'login.html';
    }

    // Load users on page load
    loadUsers();
  </script>
</body>
</html>